<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운동 & 식단 기록</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .profile-button {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .profile-button:hover {
            background-color: #219a52;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }

        .profile-info h3 {
            margin: 0 0 10px 0;
            color: #27ae60;
        }

        .profile-info p {
            margin: 5px 0;
            color: #555;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            border-right: 1px solid #ddd;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparison-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .comparison-item.planned {
            border-left-color: #f39c12;
        }

        .comparison-item.actual {
            border-left-color: #27ae60;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .achievement-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .achievement-badge.excellent {
            background: #27ae60;
            color: white;
        }

        .achievement-badge.good {
            background: #f39c12;
            color: white;
        }

        .achievement-badge.needs-improvement {
            background: #e74c3c;
            color: white;
        }

        .plan-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plan-info {
            flex: 1;
        }

        .plan-status {
            font-weight: bold;
            margin-right: 10px;
        }

        .plan-status.completed {
            color: #27ae60;
        }

        .plan-status.partial {
            color: #f39c12;
        }

        .plan-status.pending {
            color: #e74c3c;
        }

        .recommendation-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .recommendation-section h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .recommendation-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 10px;
        }

        .recommendation-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .recommendation-result {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .recommendation-result h4 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .recommendation-result p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .encouragement-text {
            font-style: italic;
            color: #e8f5e8;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .exercise-recommendation {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffd700;
        }

        .add-to-plan-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .add-to-plan-btn:hover {
            background: #219a52;
        }

        .nutrition-scanner {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: all 0.3s;
        }

        .nutrition-scanner:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .nutrition-scanner.active {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .scanner-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background 0.3s;
        }

        .scanner-button:hover {
            background: #138496;
        }

        .scanner-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }

        .analysis-result {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .analysis-result.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .analysis-result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nutrition-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }

        .nutrition-info h5 {
            margin: 0 0 10px 0;
            color: #27ae60;
        }

        .nutrition-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .nutrition-value {
            background: white;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }

        .apply-nutrition-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .apply-nutrition-btn:hover {
            background: #219a52;
        }

        .web-search-section {
            background: #e8f4fd;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            transition: all 0.3s;
        }

        .web-search-section:hover {
            border-color: #2980b9;
            background: #dbeafe;
        }

        .web-search-section.searching {
            border-color: #f39c12;
            background: #fef3cd;
        }

        .web-search-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background 0.3s;
        }

        .web-search-button:hover {
            background: #2980b9;
        }

        .web-search-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .search-input-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
            align-items: center;
        }

        .web-search-input {
            flex: 1;
            max-width: 300px;
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1em;
        }

        .web-search-results {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            text-align: left;
        }

        .web-search-results.show {
            display: block;
        }

        .web-search-results.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .web-search-results.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .nutrition-found {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }

        .nutrition-found h5 {
            color: #27ae60;
            margin: 0 0 10px 0;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .nutrition-item {
            background: white;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }

        .nutrition-item strong {
            display: block;
            color: #2c3e50;
        }

        .apply-web-search-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-size: 1em;
        }

        .apply-web-search-btn:hover {
            background: #219a52;
        }

        .search-sources {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }

        .search-disclaimer {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-width: 350px;
            font-size: 0.9em;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .toast.warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .toast.info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .toast-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: inherit;
            margin-left: 10px;
        }

        .nutrition-input {
            position: relative;
        }

        .nutrition-input.error {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .encouragement-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .encouragement-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 10% auto;
            padding: 40px;
            border: none;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            color: white;
            position: relative;
            animation: slideUp 0.4s ease;
        }

        .encouragement-modal h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .encouragement-message {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 30px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .encouragement-stats {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            backdrop-filter: blur(5px);
        }

        .encouragement-stats h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .achievement-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.95em;
        }

        .achievement-detail strong {
            color: #ffd700;
        }

        .encouragement-ok-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .encouragement-ok-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .celebration-emoji {
            font-size: 3em;
            margin-bottom: 20px;
            animation: bounce 0.6s ease infinite alternate;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .encouragement-modal.show {
            display: block;
        }

        .edit-record-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-right: 5px;
            transition: background 0.3s;
        }

        .edit-record-btn:hover {
            background: #e67e22;
        }

        .record-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .edit-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .edit-modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .edit-form-group {
            margin-bottom: 15px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .edit-form-group input, .edit-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .edit-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .edit-save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .edit-save-btn:hover {
            background: #219a52;
        }

        .edit-cancel-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .edit-cancel-btn:hover {
            background: #7f8c8d;
        }

        .edit-profile-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .edit-profile-btn:hover {
            background: #e67e22;
        }

        .profile-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .profile-display-text {
            flex: 1;
        }

        .date-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .date-selector input {
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background-color: #f0f0f0;
        }

        .btn {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .records {
            margin-top: 20px;
        }

        .record-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-info {
            flex: 1;
        }

        .record-calories {
            font-weight: bold;
            color: #e74c3c;
            margin-right: 10px;
        }

        .summary {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💪 운동 & 식단 기록</h1>
            <p>건강한 생활을 위한 운동과 식단 관리</p>
            <button class="profile-button" onclick="openProfileModal()">⚙️ 프로필 설정</button>
            <div id="profileInfo" class="profile-info" style="display: none;">
                <h3>👤 내 정보</h3>
                <div class="profile-actions">
                    <div class="profile-display-text">
                        <p id="profileDisplay"></p>
                    </div>
                    <button class="edit-profile-btn" onclick="editProfile()">✏️ 수정</button>
                </div>
            </div>
        </div>

        <div class="date-selector">
            <label for="recordDate">날짜 선택:</label>
            <input type="date" id="recordDate">
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('record')">📝 기록</button>
            <button class="tab-button" onclick="showTab('plan')">📋 계획</button>
            <button class="tab-button" onclick="showTab('compare')">📊 비교</button>
        </div>

        <div id="recordTab" class="tab-content active">
            <div class="main-content">
            <div class="section">
                <h2>🏃‍♀️ 운동 기록</h2>
                <form id="exerciseForm">
                    <div class="form-group">
                        <label for="exerciseSearch">운동 검색:</label>
                        <div class="search-container">
                            <input type="text" id="exerciseSearch" placeholder="운동 이름을 검색하세요">
                            <div class="search-results" id="exerciseResults"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exerciseName">운동 이름:</label>
                        <input type="text" id="exerciseName" required>
                    </div>
                    <div class="form-group">
                        <label for="exerciseDuration">운동 시간 (분):</label>
                        <input type="number" id="exerciseDuration" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="exerciseCalories">소모 칼로리:</label>
                        <input type="number" id="exerciseCalories" readonly>
                    </div>
                    <button type="submit" class="btn">운동 기록 추가</button>
                </form>
                
                <div class="records" id="exerciseRecords">
                    <h3>오늘의 운동 기록</h3>
                </div>
            </div>

            <div class="section">
                <h2>🍽️ 식단 기록</h2>
                <form id="foodForm">
                    <div class="form-group">
                        <label for="foodSearch">음식 검색:</label>
                        <div class="search-container">
                            <input type="text" id="foodSearch" placeholder="음식 이름을 검색하세요">
                            <div class="search-results" id="foodResults"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="foodName">음식 이름:</label>
                        <input type="text" id="foodName" required>
                    </div>
                    <div class="form-group">
                        <label for="foodAmount">양 (g):</label>
                        <input type="number" id="foodAmount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="foodCalories">칼로리:</label>
                        <input type="number" id="foodCalories" min="0" step="0.1" placeholder="수동 입력 가능">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="foodCarbs">탄수화물 (g):</label>
                            <input type="number" id="foodCarbs" step="0.1" min="0" placeholder="수동 입력 가능">
                        </div>
                        <div class="form-group">
                            <label for="foodProtein">단백질 (g):</label>
                            <input type="number" id="foodProtein" step="0.1" min="0" placeholder="수동 입력 가능">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="foodFat">지방 (g):</label>
                        <input type="number" id="foodFat" step="0.1" min="0" placeholder="수동 입력 가능">
                    </div>
                    
                    <div class="nutrition-scanner">
                        <h4>📷 영양성분표 스캔</h4>
                        <p>제품 영양성분표 사진을 업로드하면 자동으로 영양소 정보를 입력해드립니다.</p>
                        <input type="file" id="nutritionImage" accept="image/*" style="display: none;">
                        <button type="button" class="scanner-button" onclick="selectNutritionImage()">📷 사진 선택</button>
                        <button type="button" class="scanner-button" id="analyzeBtn" onclick="analyzeNutritionImage()" disabled>🔍 분석 시작</button>
                        
                        <div id="imagePreview" style="display: none;">
                            <img id="previewImg" class="image-preview" alt="영양성분표 미리보기">
                        </div>
                        
                        <div id="analysisResult" class="analysis-result">
                            <div id="analysisContent"></div>
                        </div>
                    </div>
                    
                    <div class="web-search-section">
                        <h4>🔍 웹에서 칼로리 검색</h4>
                        <p>데이터베이스에 없는 음식의 영양 정보를 웹에서 검색해드립니다.</p>
                        <div class="search-input-container">
                            <input type="text" id="webSearchInput" class="web-search-input" placeholder="예: 삼각김밥 칼로리">
                            <button type="button" class="web-search-button" id="webSearchBtn" onclick="searchFoodNutrition()">🔍 검색</button>
                        </div>
                        <div id="webSearchResults" class="web-search-results"></div>
                    </div>
                    <div class="form-group">
                        <label for="mealTime">식사 시간:</label>
                        <select id="mealTime">
                            <option value="breakfast">아침</option>
                            <option value="lunch">점심</option>
                            <option value="dinner">저녁</option>
                            <option value="snack">간식</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">식단 기록 추가</button>
                </form>
                
                <div class="records" id="foodRecords">
                    <h3>오늘의 식단 기록</h3>
                </div>
            </div>
        </div>

            <div class="summary">
            <h2>📊 일일 요약</h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCaloriesConsumed">0</div>
                    <div class="stat-label">섭취 칼로리</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCaloriesBurned">0</div>
                    <div class="stat-label">소모 칼로리</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="netCalories">0</div>
                    <div class="stat-label">순 칼로리</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalExerciseTime">0</div>
                    <div class="stat-label">운동 시간 (분)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCarbs">0</div>
                    <div class="stat-label">탄수화물 (g)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProtein">0</div>
                    <div class="stat-label">단백질 (g)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFat">0</div>
                    <div class="stat-label">지방 (g)</div>
                </div>
            </div>
            </div>
        </div>

        <div id="planTab" class="tab-content">
            <div class="main-content">
                <div class="section">
                    <h2>📋 운동 계획 작성</h2>
                    <form id="planForm">
                        <div class="form-group">
                            <label for="planExerciseSearch">운동 검색:</label>
                            <div class="search-container">
                                <input type="text" id="planExerciseSearch" placeholder="운동 이름을 검색하세요">
                                <div class="search-results" id="planExerciseResults"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="planExerciseName">운동 이름:</label>
                            <input type="text" id="planExerciseName" required>
                        </div>
                        <div class="form-group">
                            <label for="planExerciseDuration">계획 시간 (분):</label>
                            <input type="number" id="planExerciseDuration" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="planExerciseCalories">예상 소모 칼로리:</label>
                            <input type="number" id="planExerciseCalories" readonly>
                        </div>
                        <button type="submit" class="btn">계획 추가</button>
                    </form>
                    
                    <div class="records" id="planRecords">
                        <h3>오늘의 운동 계획</h3>
                    </div>
                    
                    <div id="recommendationSection" class="recommendation-section" style="display: none;">
                        <h3>🎯 목표 달성을 위한 운동 추천</h3>
                        <p>오늘 운동 계획이 비어있습니다. 목표 달성을 위한 맞춤형 운동을 추천해드릴까요?</p>
                        <button class="recommendation-button" onclick="getExerciseRecommendation()">💪 운동 추천 받기</button>
                        <div id="recommendationResult" class="recommendation-result" style="display: none;"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>🎯 계획 요약</h2>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="plannedCalories">0</div>
                            <div class="stat-label">계획된 소모 칼로리</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="plannedTime">0</div>
                            <div class="stat-label">계획된 운동 시간 (분)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="plannedExercises">0</div>
                            <div class="stat-label">계획된 운동 수</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="compareTab" class="tab-content">
            <div class="comparison-section">
                <h2>📊 계획 vs 실제 비교</h2>
                <div class="comparison-grid">
                    <div class="comparison-item planned">
                        <h3>📋 계획</h3>
                        <p>소모 칼로리: <span id="comparePlannedCalories">0</span>kcal</p>
                        <p>운동 시간: <span id="comparePlannedTime">0</span>분</p>
                        <p>운동 수: <span id="comparePlannedCount">0</span>개</p>
                    </div>
                    <div class="comparison-item actual">
                        <h3>✅ 실제</h3>
                        <p>소모 칼로리: <span id="compareActualCalories">0</span>kcal</p>
                        <p>운동 시간: <span id="compareActualTime">0</span>분</p>
                        <p>운동 수: <span id="compareActualCount">0</span>개</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>🎯 달성률</h3>
                    <div>
                        <span>칼로리 달성률: <span id="calorieAchievement">0%</span></span>
                        <span id="calorieBadge" class="achievement-badge"></span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="calorieProgress"></div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span>시간 달성률: <span id="timeAchievement">0%</span></span>
                        <span id="timeBadge" class="achievement-badge"></span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="timeProgress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="comparison-section">
                <h2>📋 세부 운동 비교</h2>
                <div id="detailedComparison"></div>
            </div>
        </div>
    </div>

    <!-- 운동 기록 수정 모달 -->
    <div id="editExerciseModal" class="edit-modal">
        <div class="edit-modal-content">
            <h3>✏️ 운동 기록 수정</h3>
            <form id="editExerciseForm">
                <div class="edit-form-group">
                    <label for="editExerciseName">운동 이름:</label>
                    <input type="text" id="editExerciseName" required>
                </div>
                <div class="edit-form-group">
                    <label for="editExerciseDuration">운동 시간 (분):</label>
                    <input type="number" id="editExerciseDuration" min="1" required>
                </div>
                <div class="edit-form-group">
                    <label for="editExerciseCalories">소모 칼로리:</label>
                    <input type="number" id="editExerciseCalories" readonly>
                </div>
                <div class="edit-form-actions">
                    <button type="button" class="edit-cancel-btn" onclick="closeEditExerciseModal()">취소</button>
                    <button type="submit" class="edit-save-btn">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 운동 계획 수정 모달 -->
    <div id="editPlanModal" class="edit-modal">
        <div class="edit-modal-content">
            <h3>✏️ 운동 계획 수정</h3>
            <form id="editPlanForm">
                <div class="edit-form-group">
                    <label for="editPlanExerciseName">운동 이름:</label>
                    <input type="text" id="editPlanExerciseName" required>
                </div>
                <div class="edit-form-group">
                    <label for="editPlanExerciseDuration">계획 시간 (분):</label>
                    <input type="number" id="editPlanExerciseDuration" min="1" required>
                </div>
                <div class="edit-form-group">
                    <label for="editPlanExerciseCalories">예상 소모 칼로리:</label>
                    <input type="number" id="editPlanExerciseCalories" readonly>
                </div>
                <div class="edit-form-actions">
                    <button type="button" class="edit-cancel-btn" onclick="closeEditPlanModal()">취소</button>
                    <button type="submit" class="edit-save-btn">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 식단 기록 수정 모달 -->
    <div id="editFoodModal" class="edit-modal">
        <div class="edit-modal-content">
            <h3>✏️ 식단 기록 수정</h3>
            <form id="editFoodForm">
                <div class="edit-form-group">
                    <label for="editFoodName">음식 이름:</label>
                    <input type="text" id="editFoodName" required>
                </div>
                <div class="edit-form-group">
                    <label for="editFoodAmount">양 (g):</label>
                    <input type="number" id="editFoodAmount" min="1" required>
                </div>
                <div class="edit-form-group">
                    <label for="editFoodCalories">칼로리:</label>
                    <input type="number" id="editFoodCalories" min="0" step="0.1" placeholder="수동 입력 가능">
                </div>
                <div class="form-row">
                    <div class="edit-form-group">
                        <label for="editFoodCarbs">탄수화물 (g):</label>
                        <input type="number" id="editFoodCarbs" step="0.1" min="0" placeholder="수동 입력 가능">
                    </div>
                    <div class="edit-form-group">
                        <label for="editFoodProtein">단백질 (g):</label>
                        <input type="number" id="editFoodProtein" step="0.1" min="0" placeholder="수동 입력 가능">
                    </div>
                </div>
                <div class="edit-form-group">
                    <label for="editFoodFat">지방 (g):</label>
                    <input type="number" id="editFoodFat" step="0.1" min="0" placeholder="수동 입력 가능">
                </div>
                <div class="edit-form-group">
                    <label for="editMealTime">식사 시간:</label>
                    <select id="editMealTime">
                        <option value="breakfast">아침</option>
                        <option value="lunch">점심</option>
                        <option value="dinner">저녁</option>
                        <option value="snack">간식</option>
                    </select>
                </div>
                <div class="edit-form-actions">
                    <button type="button" class="edit-cancel-btn" onclick="closeEditFoodModal()">취소</button>
                    <button type="submit" class="edit-save-btn">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 격려 메시지 모달 -->
    <div id="encouragementModal" class="encouragement-modal">
        <div class="encouragement-modal-content">
            <div class="celebration-emoji" id="celebrationEmoji">🎉</div>
            <h2 id="encouragementTitle">축하합니다!</h2>
            <div class="encouragement-message" id="encouragementMessage">
                오늘도 힘차게 운동했네요. 잘하셨습니다!
            </div>
            <div class="encouragement-stats" id="encouragementStats">
                <h4>🎯 달성한 계획</h4>
                <div id="achievementDetails"></div>
            </div>
            <button class="encouragement-ok-btn" onclick="closeEncouragementModal()">확인</button>
        </div>
    </div>

    <!-- 프로필 설정 모달 -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2>👤 프로필 설정</h2>
            <p>정확한 칼로리 계산을 위해 개인 정보를 입력해주세요.</p>
            <form id="profileForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userAge">나이:</label>
                        <input type="number" id="userAge" min="10" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="userGender">성별:</label>
                        <select id="userGender" required>
                            <option value="">선택하세요</option>
                            <option value="male">남성</option>
                            <option value="female">여성</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userHeight">키 (cm):</label>
                        <input type="number" id="userHeight" min="100" max="250" required>
                    </div>
                    <div class="form-group">
                        <label for="userWeight">현재 체중 (kg):</label>
                        <input type="number" id="userWeight" min="30" max="200" step="0.1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="targetWeight">목표 체중 (kg):</label>
                    <input type="number" id="targetWeight" min="30" max="200" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="weightGoal">목표 유형:</label>
                    <select id="weightGoal" required>
                        <option value="">선택하세요</option>
                        <option value="lose">체중 감량</option>
                        <option value="maintain">체중 유지</option>
                        <option value="gain">체중 증가</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="activityLevel">일상 활동 수준:</label>
                    <select id="activityLevel" required>
                        <option value="">선택하세요</option>
                        <option value="sedentary">좌식 생활 (운동 거의 안함)</option>
                        <option value="light">가벼운 활동 (주 1-3회 운동)</option>
                        <option value="moderate">보통 활동 (주 3-5회 운동)</option>
                        <option value="active">활발한 활동 (주 6-7회 운동)</option>
                        <option value="very_active">매우 활발 (하루 2회 운동)</option>
                    </select>
                </div>
                <button type="submit" class="btn">프로필 저장</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
    <script>
        // MET 값 기반 운동 데이터베이스 (Metabolic Equivalent of Task)
        const exerciseDatabase = {
            '달리기': { met: 8.0, description: '보통 속도 (8km/h)' },
            '걷기': { met: 3.5, description: '보통 속도 (5km/h)' },
            '자전거': { met: 6.8, description: '보통 속도 (16km/h)' },
            '수영': { met: 6.0, description: '자유형 보통 속도' },
            '요가': { met: 2.5, description: '하타 요가' },
            '헬스': { met: 6.0, description: '웨이트 트레이닝' },
            '농구': { met: 8.0, description: '일반 게임' },
            '축구': { met: 7.0, description: '일반 게임' },
            '배드민턴': { met: 5.5, description: '레크리에이션' },
            '테니스': { met: 7.3, description: '싱글 게임' },
            '등산': { met: 7.3, description: '평균 경사도' },
            '스쿼트': { met: 5.0, description: '체중 운동' },
            '팔굽혀펴기': { met: 3.8, description: '체중 운동' },
            '플랭크': { met: 3.3, description: '정적 운동' },
            '줄넘기': { met: 11.0, description: '보통 속도' },
            '에어로빅': { met: 6.5, description: '저강도' },
            '필라테스': { met: 3.0, description: '매트 운동' },
            '태권도': { met: 10.3, description: '스파링' },
            '복싱': { met: 9.5, description: '일반 연습' },
            '크로스핏': { met: 10.5, description: '고강도' }
        };

        const foodDatabase = {
            '밥': { calories: 130, carbs: 28, protein: 2.7, fat: 0.3, per: 100 },
            '김치': { calories: 18, carbs: 2.4, protein: 2.0, fat: 0.6, per: 100 },
            '된장찌개': { calories: 55, carbs: 6.2, protein: 4.8, fat: 1.8, per: 100 },
            '불고기': { calories: 280, carbs: 2.5, protein: 26.0, fat: 18.0, per: 100 },
            '치킨': { calories: 250, carbs: 0, protein: 25.0, fat: 16.0, per: 100 },
            '피자': { calories: 266, carbs: 33.0, protein: 11.0, fat: 10.0, per: 100 },
            '햄버거': { calories: 295, carbs: 30.0, protein: 17.0, fat: 12.0, per: 100 },
            '라면': { calories: 380, carbs: 55.0, protein: 10.0, fat: 14.0, per: 100 },
            '사과': { calories: 52, carbs: 14.0, protein: 0.3, fat: 0.2, per: 100 },
            '바나나': { calories: 89, carbs: 23.0, protein: 1.1, fat: 0.3, per: 100 },
            '우유': { calories: 42, carbs: 5.0, protein: 3.4, fat: 1.0, per: 100 },
            '계란': { calories: 155, carbs: 1.1, protein: 13.0, fat: 11.0, per: 100 },
            '빵': { calories: 265, carbs: 49.0, protein: 9.0, fat: 4.2, per: 100 },
            '샐러드': { calories: 20, carbs: 3.6, protein: 1.4, fat: 0.2, per: 100 },
            '스파게티': { calories: 131, carbs: 25.0, protein: 5.0, fat: 1.1, per: 100 },
            '초콜릿': { calories: 546, carbs: 61.0, protein: 7.8, fat: 31.0, per: 100 },
            '아이스크림': { calories: 207, carbs: 24.0, protein: 3.5, fat: 11.0, per: 100 },
            '콜라': { calories: 42, carbs: 10.6, protein: 0, fat: 0, per: 100 },
            '커피': { calories: 2, carbs: 0, protein: 0.3, fat: 0, per: 100 },
            '맥주': { calories: 43, carbs: 3.6, protein: 0.5, fat: 0, per: 100 }
        };

        // 오늘 날짜 설정
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;

        // 사용자 프로필 관리
        function loadUserProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if (profile) {
                document.getElementById('userAge').value = profile.age;
                document.getElementById('userGender').value = profile.gender;
                document.getElementById('userHeight').value = profile.height;
                document.getElementById('userWeight').value = profile.weight;
                document.getElementById('targetWeight').value = profile.targetWeight || '';
                document.getElementById('weightGoal').value = profile.weightGoal || '';
                document.getElementById('activityLevel').value = profile.activityLevel;
                displayProfileInfo(profile);
            }
        }

        function saveUserProfile() {
            const profile = {
                age: parseInt(document.getElementById('userAge').value),
                gender: document.getElementById('userGender').value,
                height: parseInt(document.getElementById('userHeight').value),
                weight: parseFloat(document.getElementById('userWeight').value),
                targetWeight: parseFloat(document.getElementById('targetWeight').value),
                weightGoal: document.getElementById('weightGoal').value,
                activityLevel: document.getElementById('activityLevel').value
            };
            localStorage.setItem('userProfile', JSON.stringify(profile));
            displayProfileInfo(profile);
            return profile;
        }

        function displayProfileInfo(profile) {
            const bmi = (profile.weight / Math.pow(profile.height / 100, 2)).toFixed(1);
            const bmr = calculateBMR(profile);
            const tdee = calculateTDEE(bmr, profile.activityLevel);
            
            let weightStatus = '';
            if (profile.targetWeight) {
                const weightDiff = profile.targetWeight - profile.weight;
                const weightGoalText = {
                    'lose': '감량',
                    'maintain': '유지', 
                    'gain': '증가'
                };
                
                if (Math.abs(weightDiff) < 0.5) {
                    weightStatus = `<br>🎯 목표 달성! (목표: ${profile.targetWeight}kg)`;
                } else {
                    const direction = weightDiff > 0 ? '+' : '';
                    weightStatus = `<br>🎯 목표: ${profile.targetWeight}kg (${direction}${weightDiff.toFixed(1)}kg ${weightGoalText[profile.weightGoal] || ''})`;
                }
            }
            
            document.getElementById('profileDisplay').innerHTML = `
                ${profile.gender === 'male' ? '남성' : '여성'}, ${profile.age}세, ${profile.height}cm, ${profile.weight}kg<br>
                BMI: ${bmi} | 기초대사율: ${bmr.toFixed(0)}kcal | 일일 소모: ${tdee.toFixed(0)}kcal${weightStatus}
            `;
            document.getElementById('profileInfo').style.display = 'block';
        }

        // 기초대사율 계산 (Harris-Benedict 공식)
        function calculateBMR(profile) {
            if (profile.gender === 'male') {
                return 88.362 + (13.397 * profile.weight) + (4.799 * profile.height) - (5.677 * profile.age);
            } else {
                return 447.593 + (9.247 * profile.weight) + (3.098 * profile.height) - (4.330 * profile.age);
            }
        }

        // 일일 총 소모 칼로리 계산 (TDEE)
        function calculateTDEE(bmr, activityLevel) {
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            return bmr * activityMultipliers[activityLevel];
        }

        // 개인화된 칼로리 계산 (MET 공식: METs × 체중(kg) × 시간(시간))
        function calculatePersonalizedCalories(exercise, duration) {
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if (!profile || !exerciseDatabase[exercise]) {
                return exerciseDatabase[exercise] ? exerciseDatabase[exercise].met * 70 * (duration / 60) : 0;
            }
            
            const met = exerciseDatabase[exercise].met;
            const weight = profile.weight;
            const hours = duration / 60;
            
            return Math.round(met * weight * hours);
        }

        // 모달 관리
        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profileModal').dataset.editing = 'false';
            // 새로운 프로필 작성시 폼 초기화
            document.getElementById('profileForm').reset();
        }

        function editProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if (!profile) {
                alert('수정할 프로필이 없습니다.');
                return;
            }
            
            // 모달에 기존 데이터 채우기
            document.getElementById('userAge').value = profile.age;
            document.getElementById('userGender').value = profile.gender;
            document.getElementById('userHeight').value = profile.height;
            document.getElementById('userWeight').value = profile.weight;
            document.getElementById('targetWeight').value = profile.targetWeight || '';
            document.getElementById('weightGoal').value = profile.weightGoal || '';
            document.getElementById('activityLevel').value = profile.activityLevel;
            
            // 수정 모드로 설정
            document.getElementById('profileModal').dataset.editing = 'true';
            document.getElementById('profileModal').style.display = 'block';
            
            // 모달 제목 변경
            document.querySelector('#profileModal h2').textContent = '👤 프로필 수정';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('profileModal').dataset.editing = 'false';
            // 모달 제목 원래대로 복구
            document.querySelector('#profileModal h2').textContent = '👤 프로필 설정';
        }

        // 프로필 폼 제출
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const isEditing = document.getElementById('profileModal').dataset.editing === 'true';
            saveUserProfile();
            closeProfileModal();
            
            if (isEditing) {
                alert('프로필이 수정되었습니다! 변경된 정보에 따라 칼로리 계산이 업데이트됩니다.');
                // 프로필 수정 후 화면 업데이트
                refreshAfterProfileUpdate();
                // 추천 운동 재검토
                checkAndShowRecommendations();
            } else {
                alert('프로필이 저장되었습니다! 이제 더 정확한 칼로리 계산이 가능합니다.');
            }
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target === modal) {
                closeProfileModal();
            }
        };

        // 프로필 수정 후 화면 업데이트
        function refreshAfterProfileUpdate() {
            // 모든 운동 칼로리 재계산 (이미 기록된 것들을 새로운 프로필로 업데이트)
            const selectedDate = document.getElementById('recordDate').value;
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            
            // 기존 운동 기록의 칼로리 재계산
            exercises.forEach(exercise => {
                exercise.calories = calculatePersonalizedCalories(exercise.name, exercise.duration);
            });
            
            // 기존 운동 계획의 칼로리 재계산
            plans.forEach(plan => {
                plan.calories = calculatePersonalizedCalories(plan.name, plan.duration);
            });
            
            // 업데이트된 데이터 저장
            localStorage.setItem(`exercises_${selectedDate}`, JSON.stringify(exercises));
            localStorage.setItem(`plans_${selectedDate}`, JSON.stringify(plans));
            
            // 화면 새로고침
            loadData();
            
            // 비교 탭이 활성화되어 있다면 업데이트
            if (document.getElementById('compareTab').classList.contains('active')) {
                updateComparison();
            }
        }

        // 로컬 스토리지에서 데이터 불러오기
        function loadData() {
            const selectedDate = document.getElementById('recordDate').value;
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            const foods = JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || [];
            
            displayExercises(exercises);
            displayFoods(foods);
            updateSummary(exercises, foods);
        }

        // 운동 검색 기능
        document.getElementById('exerciseSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('exerciseResults');
            
            if (query.length === 0) {
                results.style.display = 'none';
                return;
            }
            
            const matches = Object.keys(exerciseDatabase).filter(exercise => 
                exercise.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                results.innerHTML = matches.map(exercise => 
                    `<div class="search-item" onclick="selectExercise('${exercise}')">${exercise} (MET: ${exerciseDatabase[exercise].met})</div>`
                ).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        });

        // 음식 검색 기능
        document.getElementById('foodSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('foodResults');
            
            if (query.length === 0) {
                results.style.display = 'none';
                return;
            }
            
            const matches = Object.keys(foodDatabase).filter(food => 
                food.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                results.innerHTML = matches.map(food => 
                    `<div class="search-item" onclick="selectFood('${food}')">${food} (${foodDatabase[food].calories}cal | 탄${foodDatabase[food].carbs}g 단${foodDatabase[food].protein}g 지${foodDatabase[food].fat}g)</div>`
                ).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        });

        // 운동 선택
        function selectExercise(exercise) {
            document.getElementById('exerciseName').value = exercise;
            document.getElementById('exerciseSearch').value = exercise;
            document.getElementById('exerciseResults').style.display = 'none';
            calculateExerciseCalories();
        }

        // 음식 선택
        function selectFood(food) {
            document.getElementById('foodName').value = food;
            document.getElementById('foodSearch').value = food;
            document.getElementById('foodResults').style.display = 'none';
            calculateFoodCalories();
        }

        // 운동 칼로리 계산 (개인화된 계산)
        function calculateExerciseCalories() {
            const exerciseName = document.getElementById('exerciseName').value;
            const duration = parseInt(document.getElementById('exerciseDuration').value) || 0;
            
            if (exerciseName in exerciseDatabase) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('exerciseCalories').value = calories;
            }
        }

        // 음식 칼로리 및 영양소 계산
        function calculateFoodCalories() {
            const foodName = document.getElementById('foodName').value;
            const amount = parseInt(document.getElementById('foodAmount').value) || 0;
            
            if (foodName in foodDatabase) {
                const food = foodDatabase[foodName];
                const ratio = amount / 100;
                
                const calories = Math.round(food.calories * ratio);
                const carbs = Math.round(food.carbs * ratio * 10) / 10;
                const protein = Math.round(food.protein * ratio * 10) / 10;
                const fat = Math.round(food.fat * ratio * 10) / 10;
                
                document.getElementById('foodCalories').value = calories;
                document.getElementById('foodCarbs').value = carbs;
                document.getElementById('foodProtein').value = protein;
                document.getElementById('foodFat').value = fat;
            }
        }

        // 운동 시간 입력시 칼로리 재계산
        document.getElementById('exerciseDuration').addEventListener('input', calculateExerciseCalories);

        // 음식 양 입력시 칼로리 재계산
        document.getElementById('foodAmount').addEventListener('input', calculateFoodCalories);

        // 운동 기록 추가
        document.getElementById('exerciseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedDate = document.getElementById('recordDate').value;
            const exercise = {
                name: document.getElementById('exerciseName').value,
                duration: parseInt(document.getElementById('exerciseDuration').value),
                calories: parseInt(document.getElementById('exerciseCalories').value),
                timestamp: new Date().toLocaleTimeString()
            };
            
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            exercises.push(exercise);
            localStorage.setItem(`exercises_${selectedDate}`, JSON.stringify(exercises));
            
            displayExercises(exercises);
            updateSummary(exercises, JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || []);
            
            // 폼 초기화
            this.reset();
            document.getElementById('exerciseCalories').value = '';
        });

        // 식단 기록 추가
        document.getElementById('foodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedDate = document.getElementById('recordDate').value;
            const food = {
                name: document.getElementById('foodName').value,
                amount: parseInt(document.getElementById('foodAmount').value),
                calories: parseInt(document.getElementById('foodCalories').value),
                carbs: parseFloat(document.getElementById('foodCarbs').value) || 0,
                protein: parseFloat(document.getElementById('foodProtein').value) || 0,
                fat: parseFloat(document.getElementById('foodFat').value) || 0,
                mealTime: document.getElementById('mealTime').value,
                timestamp: new Date().toLocaleTimeString()
            };
            
            const foods = JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || [];
            foods.push(food);
            localStorage.setItem(`foods_${selectedDate}`, JSON.stringify(foods));
            
            displayFoods(foods);
            updateSummary(JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [], foods);
            
            // 폼 초기화
            this.reset();
            document.getElementById('foodCalories').value = '';
            document.getElementById('foodCarbs').value = '';
            document.getElementById('foodProtein').value = '';
            document.getElementById('foodFat').value = '';
        });

        // 운동 기록 표시
        function displayExercises(exercises) {
            const container = document.getElementById('exerciseRecords');
            container.innerHTML = '<h3>오늘의 운동 기록</h3>';
            
            exercises.forEach((exercise, index) => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-info">
                        <strong>${exercise.name}</strong> - ${exercise.duration}분
                        <br><small>${exercise.timestamp}</small>
                    </div>
                    <div class="record-calories">${exercise.calories} cal</div>
                    <div class="record-actions">
                        <button class="edit-record-btn" onclick="editExercise(${index})">✏️ 수정</button>
                        <button class="btn btn-danger" onclick="deleteExercise(${index})">삭제</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 식단 기록 표시
        function displayFoods(foods) {
            const container = document.getElementById('foodRecords');
            container.innerHTML = '<h3>오늘의 식단 기록</h3>';
            
            foods.forEach((food, index) => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-info">
                        <strong>${food.name}</strong> - ${food.amount}g (${food.mealTime})
                        <br><small>${food.timestamp}</small>
                        <br><small>탄수화물: ${food.carbs || 0}g | 단백질: ${food.protein || 0}g | 지방: ${food.fat || 0}g</small>
                    </div>
                    <div class="record-calories">${food.calories} cal</div>
                    <div class="record-actions">
                        <button class="edit-record-btn" onclick="editFood(${index})">✏️ 수정</button>
                        <button class="btn btn-danger" onclick="deleteFood(${index})">삭제</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 요약 정보 업데이트
        function updateSummary(exercises, foods) {
            const totalCaloriesBurned = exercises.reduce((sum, ex) => sum + ex.calories, 0);
            const totalCaloriesConsumed = foods.reduce((sum, food) => sum + food.calories, 0);
            const netCalories = totalCaloriesConsumed - totalCaloriesBurned;
            const totalExerciseTime = exercises.reduce((sum, ex) => sum + ex.duration, 0);
            
            // 영양소 총합
            const totalCarbs = foods.reduce((sum, food) => sum + (food.carbs || 0), 0);
            const totalProtein = foods.reduce((sum, food) => sum + (food.protein || 0), 0);
            const totalFat = foods.reduce((sum, food) => sum + (food.fat || 0), 0);
            
            document.getElementById('totalCaloriesConsumed').textContent = totalCaloriesConsumed;
            document.getElementById('totalCaloriesBurned').textContent = totalCaloriesBurned;
            document.getElementById('netCalories').textContent = netCalories;
            document.getElementById('totalExerciseTime').textContent = totalExerciseTime;
            
            // 영양소 표시 업데이트
            document.getElementById('totalCarbs').textContent = Math.round(totalCarbs * 10) / 10;
            document.getElementById('totalProtein').textContent = Math.round(totalProtein * 10) / 10;
            document.getElementById('totalFat').textContent = Math.round(totalFat * 10) / 10;
        }

        // 운동 기록 삭제
        function deleteExercise(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            exercises.splice(index, 1);
            localStorage.setItem(`exercises_${selectedDate}`, JSON.stringify(exercises));
            
            displayExercises(exercises);
            updateSummary(exercises, JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || []);
        }

        // 식단 기록 삭제
        function deleteFood(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const foods = JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || [];
            foods.splice(index, 1);
            localStorage.setItem(`foods_${selectedDate}`, JSON.stringify(foods));
            
            displayFoods(foods);
            updateSummary(JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [], foods);
        }

        // 날짜 변경시 데이터 다시 로드
        document.getElementById('recordDate').addEventListener('change', loadData);

        // 검색 결과 외부 클릭시 숨기기
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('exerciseResults').style.display = 'none';
                document.getElementById('foodResults').style.display = 'none';
                document.getElementById('planExerciseResults').style.display = 'none';
            }
        });

        // 탭 관리
        function showTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            // 모든 탭 내용 숨기기
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 탭 변경 시 데이터 새로고침
            if (tabName === 'compare') {
                updateComparison();
            }
        }

        // 운동 계획 관리
        function loadPlans() {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            displayPlans(plans);
            updatePlanSummary(plans);
            return plans;
        }

        function savePlan(plan) {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            plans.push(plan);
            localStorage.setItem(`plans_${selectedDate}`, JSON.stringify(plans));
            return plans;
        }

        function deletePlan(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            plans.splice(index, 1);
            localStorage.setItem(`plans_${selectedDate}`, JSON.stringify(plans));
            displayPlans(plans);
            updatePlanSummary(plans);
        }

        function displayPlans(plans) {
            const container = document.getElementById('planRecords');
            container.innerHTML = '<h3>오늘의 운동 계획</h3>';
            
            plans.forEach((plan, index) => {
                const div = document.createElement('div');
                div.className = 'plan-item';
                
                // 실제 운동 기록과 비교하여 상태 확인
                const exercises = JSON.parse(localStorage.getItem(`exercises_${document.getElementById('recordDate').value}`)) || [];
                const matchingExercise = exercises.find(ex => ex.name === plan.name);
                
                let status = 'pending';
                let statusText = '미완료';
                if (matchingExercise) {
                    if (matchingExercise.duration >= plan.duration) {
                        status = 'completed';
                        statusText = '완료';
                    } else {
                        status = 'partial';
                        statusText = '부분완료';
                    }
                }
                
                div.innerHTML = `
                    <div class="plan-info">
                        <strong>${plan.name}</strong> - ${plan.duration}분 (${plan.calories}kcal)
                        <br><small>계획 시간: ${plan.timestamp}</small>
                    </div>
                    <div class="plan-status ${status}">${statusText}</div>
                    <div class="record-actions">
                        <button class="edit-record-btn" onclick="editPlan(${index})">✏️ 수정</button>
                        <button class="btn btn-danger" onclick="deletePlan(${index})">삭제</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updatePlanSummary(plans) {
            const totalCalories = plans.reduce((sum, plan) => sum + plan.calories, 0);
            const totalTime = plans.reduce((sum, plan) => sum + plan.duration, 0);
            const totalExercises = plans.length;
            
            document.getElementById('plannedCalories').textContent = totalCalories;
            document.getElementById('plannedTime').textContent = totalTime;
            document.getElementById('plannedExercises').textContent = totalExercises;
        }

        // 계획 vs 실제 비교
        function updateComparison() {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            
            // 계획 데이터
            const plannedCalories = plans.reduce((sum, plan) => sum + plan.calories, 0);
            const plannedTime = plans.reduce((sum, plan) => sum + plan.duration, 0);
            const plannedCount = plans.length;
            
            // 실제 데이터
            const actualCalories = exercises.reduce((sum, ex) => sum + ex.calories, 0);
            const actualTime = exercises.reduce((sum, ex) => sum + ex.duration, 0);
            const actualCount = exercises.length;
            
            // 비교 표시
            document.getElementById('comparePlannedCalories').textContent = plannedCalories;
            document.getElementById('comparePlannedTime').textContent = plannedTime;
            document.getElementById('comparePlannedCount').textContent = plannedCount;
            
            document.getElementById('compareActualCalories').textContent = actualCalories;
            document.getElementById('compareActualTime').textContent = actualTime;
            document.getElementById('compareActualCount').textContent = actualCount;
            
            // 달성률 계산
            const calorieAchievement = plannedCalories > 0 ? Math.round((actualCalories / plannedCalories) * 100) : 0;
            const timeAchievement = plannedTime > 0 ? Math.round((actualTime / plannedTime) * 100) : 0;
            
            document.getElementById('calorieAchievement').textContent = calorieAchievement + '%';
            document.getElementById('timeAchievement').textContent = timeAchievement + '%';
            
            // 진행률 바
            document.getElementById('calorieProgress').style.width = Math.min(calorieAchievement, 100) + '%';
            document.getElementById('timeProgress').style.width = Math.min(timeAchievement, 100) + '%';
            
            // 뱃지 표시
            updateAchievementBadge('calorieBadge', calorieAchievement);
            updateAchievementBadge('timeBadge', timeAchievement);
            
            // 세부 비교
            updateDetailedComparison(plans, exercises);
        }

        function updateAchievementBadge(elementId, percentage) {
            const badge = document.getElementById(elementId);
            if (percentage >= 90) {
                badge.className = 'achievement-badge excellent';
                badge.textContent = '훌륭함';
            } else if (percentage >= 70) {
                badge.className = 'achievement-badge good';
                badge.textContent = '양호';
            } else {
                badge.className = 'achievement-badge needs-improvement';
                badge.textContent = '개선필요';
            }
        }

        function updateDetailedComparison(plans, exercises) {
            const container = document.getElementById('detailedComparison');
            container.innerHTML = '';
            
            plans.forEach(plan => {
                const matchingExercise = exercises.find(ex => ex.name === plan.name);
                const div = document.createElement('div');
                div.className = 'comparison-item';
                
                if (matchingExercise) {
                    const timeDiff = matchingExercise.duration - plan.duration;
                    const calorieDiff = matchingExercise.calories - plan.calories;
                    
                    div.innerHTML = `
                        <h4>${plan.name}</h4>
                        <p>계획: ${plan.duration}분, ${plan.calories}kcal</p>
                        <p>실제: ${matchingExercise.duration}분, ${matchingExercise.calories}kcal</p>
                        <p>차이: ${timeDiff >= 0 ? '+' : ''}${timeDiff}분, ${calorieDiff >= 0 ? '+' : ''}${calorieDiff}kcal</p>
                    `;
                    div.style.borderLeftColor = timeDiff >= 0 ? '#27ae60' : '#e74c3c';
                } else {
                    div.innerHTML = `
                        <h4>${plan.name}</h4>
                        <p>계획: ${plan.duration}분, ${plan.calories}kcal</p>
                        <p style="color: #e74c3c;">실제: 미완료</p>
                    `;
                    div.style.borderLeftColor = '#e74c3c';
                }
                
                container.appendChild(div);
            });
        }

        // 계획 폼 이벤트
        document.getElementById('planForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const plan = {
                name: document.getElementById('planExerciseName').value,
                duration: parseInt(document.getElementById('planExerciseDuration').value),
                calories: parseInt(document.getElementById('planExerciseCalories').value),
                timestamp: new Date().toLocaleTimeString()
            };
            
            const plans = savePlan(plan);
            displayPlans(plans);
            updatePlanSummary(plans);
            
            // 폼 초기화
            this.reset();
            document.getElementById('planExerciseCalories').value = '';
        });

        // 계획 운동 검색
        document.getElementById('planExerciseSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('planExerciseResults');
            
            if (query.length === 0) {
                results.style.display = 'none';
                return;
            }
            
            const matches = Object.keys(exerciseDatabase).filter(exercise => 
                exercise.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                results.innerHTML = matches.map(exercise => 
                    `<div class="search-item" onclick="selectPlanExercise('${exercise}')">${exercise} (MET: ${exerciseDatabase[exercise].met})</div>`
                ).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        });

        // 계획 운동 선택
        function selectPlanExercise(exercise) {
            document.getElementById('planExerciseName').value = exercise;
            document.getElementById('planExerciseSearch').value = exercise;
            document.getElementById('planExerciseResults').style.display = 'none';
            calculatePlanExerciseCalories();
        }

        // 계획 운동 칼로리 계산
        function calculatePlanExerciseCalories() {
            const exerciseName = document.getElementById('planExerciseName').value;
            const duration = parseInt(document.getElementById('planExerciseDuration').value) || 0;
            
            if (exerciseName in exerciseDatabase) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('planExerciseCalories').value = calories;
            }
        }

        // 계획 운동 시간 입력시 칼로리 재계산
        document.getElementById('planExerciseDuration').addEventListener('input', calculatePlanExerciseCalories);

        // 운동 추천 시스템
        function getExerciseRecommendation() {
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if (!profile || !profile.targetWeight) {
                alert('바른 추천을 위해 먼저 프로필을 설정해주세요!');
                return;
            }

            const recommendations = generateExerciseRecommendations(profile);
            displayRecommendations(recommendations, profile);
        }

        function generateExerciseRecommendations(profile) {
            const weightDiff = profile.targetWeight - profile.weight;
            const isWeightLoss = weightDiff < 0;
            const isWeightGain = weightDiff > 0;
            const isMaintenance = Math.abs(weightDiff) < 0.5;

            let recommendations = [];
            
            if (isWeightLoss) {
                // 체중 감량을 위한 운동
                recommendations = [
                    { exercise: '달리기', duration: 30, reason: '지방 연소에 효과적인 유산소 운동' },
                    { exercise: '빠른 걸기', duration: 45, reason: '부담이 적으며 지속가능한 운동' },
                    { exercise: '수영', duration: 30, reason: '전신 운동으로 칼로리 소모량이 높음' },
                    { exercise: '줄넘기', duration: 20, reason: '짧은 시간에 높은 칼로리 소모' }
                ];
            } else if (isWeightGain) {
                // 체중 증가를 위한 운돔 (근력 운동 중심)
                recommendations = [
                    { exercise: '헬스', duration: 45, reason: '근력 증가와 건강한 체중 증가에 도움' },
                    { exercise: '스쿼트', duration: 30, reason: '하체 근력 강화와 기초대사율 증가' },
                    { exercise: '팔굽혀펴기', duration: 15, reason: '상체 근력 강화와 근육량 증가' },
                    { exercise: '요가', duration: 30, reason: '유연성과 균형감각 향상' }
                ];
            } else {
                // 체중 유지를 위한 운동
                recommendations = [
                    { exercise: '빠른 걸기', duration: 30, reason: '심폐기능 유지와 기초체력 강화' },
                    { exercise: '요가', duration: 30, reason: '유연성과 스트레스 관리에 도움' },
                    { exercise: '에어로빅', duration: 30, reason: '전신 운동으로 체력 유지에 효과적' },
                    { exercise: '필라테스', duration: 30, reason: '근력과 자세 개선에 도움' }
                ];
            }

            // 체중 차이에 따른 강도 조절
            const intensity = Math.abs(weightDiff);
            if (intensity > 10) {
                recommendations.forEach(rec => {
                    rec.duration = Math.min(rec.duration + 15, 60);
                });
            } else if (intensity > 5) {
                recommendations.forEach(rec => {
                    rec.duration = Math.min(rec.duration + 10, 60);
                });
            }

            return recommendations.slice(0, 3); // 상위 3개 추천
        }

        function displayRecommendations(recommendations, profile) {
            const resultDiv = document.getElementById('recommendationResult');
            const weightDiff = profile.targetWeight - profile.weight;
            const goalText = profile.weightGoal === 'lose' ? '감량' : 
                           profile.weightGoal === 'gain' ? '증가' : '유지';
            
            const encouragementMessages = {
                'lose': [
                    '하루하루 꿈에 가까워지고 있어요! 오늘도 화이팅! 💪',
                    '졸은 시작이 반이에요. 오늘부터 시작해볼까요? 🎆',
                    '일주일에 3-4회만 해도 분명 변화를 느낄 수 있을 거예요! 🌟',
                    '상상도 못할 내일의 내 모습을 위해 오늘 시작해요! ✨'
                ],
                'gain': [
                    '건강한 근육을 만들어가는 여정, 응원할게요! 💪',
                    '근력운동은 외모도 건강도 둘 다 잡는 일석이조! 🎆',
                    '오늘의 열심이 내일의 더 단단한 나를 만들어요! 🌟',
                    '건강한 몸을 만드는 것은 대단한 도전이에요. 축하해요! ✨'
                ],
                'maintain': [
                    '지금의 좋은 상태를 유지하는 것도 미덕이에요! 💪',
                    '건강한 삶의 비결은 바로 꿈임없는 운동이죠! 🎆',
                    '오늘도 건강한 하루를 선택하신 당신이 대단해요! 🌟',
                    '운동이 부담스럽지 않을 때 시작하는 것이 최고! ✨'
                ]
            };

            const randomMessage = encouragementMessages[profile.weightGoal] ? 
                encouragementMessages[profile.weightGoal][Math.floor(Math.random() * encouragementMessages[profile.weightGoal].length)] :
                '오늘도 건강한 하루 보내세요! 💪';

            let recommendationHTML = `
                <h4>🎯 목표: ${Math.abs(weightDiff).toFixed(1)}kg ${goalText}</h4>
                <p><strong>추천 운동 메뉴:</strong></p>
            `;

            recommendations.forEach((rec, index) => {
                const calories = calculatePersonalizedCalories(rec.exercise, rec.duration);
                recommendationHTML += `
                    <div class="exercise-recommendation">
                        <strong>${index + 1}. ${rec.exercise}</strong> - ${rec.duration}분 (${calories}kcal)
                        <br><small>📝 ${rec.reason}</small>
                        <br><button class="add-to-plan-btn" onclick="addRecommendationToPlan('${rec.exercise}', ${rec.duration}, ${calories})">📝 계획에 추가</button>
                    </div>
                `;
            });

            recommendationHTML += `
                <p class="encouragement-text">${randomMessage}</p>
            `;

            resultDiv.innerHTML = recommendationHTML;
            resultDiv.style.display = 'block';
        }

        function addRecommendationToPlan(exercise, duration, calories) {
            const plan = {
                name: exercise,
                duration: duration,
                calories: calories,
                timestamp: new Date().toLocaleTimeString()
            };
            
            const plans = savePlan(plan);
            displayPlans(plans);
            updatePlanSummary(plans);
            
            // 추천 섹션 숨기기
            checkAndShowRecommendations();
            
            alert(`${exercise} 운동이 계획에 추가되었습니다!`);
        }

        function checkAndShowRecommendations() {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            
            const recommendationSection = document.getElementById('recommendationSection');
            
            // 계획이나 기록이 있고, 목표 체중이 설정된 경우에만 추천 보이기
            if (plans.length === 0 && exercises.length === 0 && profile && profile.targetWeight) {
                recommendationSection.style.display = 'block';
            } else {
                recommendationSection.style.display = 'none';
            }
        }

        // 기존 loadData 함수 수정
        const originalLoadData = loadData;
        loadData = function() {
            originalLoadData();
            loadPlans();
            checkAndShowRecommendations();
        };

        // 영양성분표 이미지 분석 기능
        let selectedNutritionImage = null;

        function selectNutritionImage() {
            document.getElementById('nutritionImage').click();
        }

        document.getElementById('nutritionImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedNutritionImage = file;
                
                // 이미지 미리보기
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('analyzeBtn').disabled = false;
                    document.querySelector('.nutrition-scanner').classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });

        function analyzeNutritionImage() {
            if (!selectedNutritionImage) {
                alert('먼저 이미지를 선택해주세요.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('analysisResult');
            const contentDiv = document.getElementById('analysisContent');
            
            // 로딩 상태 표시
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading-spinner"></div>분석 중...';
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'analysis-result';
            contentDiv.innerHTML = '<p>영양성분표를 분석하고 있습니다. 잠시만 기다려주세요...</p>';

            // Tesseract.js로 OCR 수행
            Tesseract.recognize(selectedNutritionImage, 'kor+eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = Math.round(m.progress * 100);
                        contentDiv.innerHTML = `<p>텍스트 인식 중... ${progress}%</p>`;
                    }
                }
            }).then(({ data: { text } }) => {
                console.log('인식된 텍스트:', text);
                
                // 영양성분 정보 추출
                const nutritionData = parseNutritionText(text);
                
                if (nutritionData) {
                    displayNutritionResults(nutritionData);
                } else {
                    showAnalysisError('영양성분 정보를 인식하지 못했습니다. 이미지가 명확한지 확인해주세요.');
                }
            }).catch(error => {
                console.error('OCR 에러:', error);
                showAnalysisError('이미지 분석 중 오류가 발생했습니다.');
            }).finally(() => {
                // 로딩 상태 해제
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🔍 분석 시작';
            });
        }

        function parseNutritionText(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const nutritionData = {
                calories: null,
                carbs: null,
                protein: null,
                fat: null,
                name: null
            };

            // 제품명 추출 (처음 별의 숫자가 없는 긴 줄)
            for (let i = 0; i < Math.min(lines.length, 5); i++) {
                const line = lines[i];
                if (line.length > 3 && !/\d/.test(line) && !/칼로리|열량|탄수화물|단백질|지방|carbohydrate|protein|fat|calorie/i.test(line)) {
                    nutritionData.name = line;
                    break;
                }
            }

            // 영양성분 정보 추출
            for (const line of lines) {
                const lowerLine = line.toLowerCase();
                
                // 칼로리 추출
                if ((/칼로리|열량|calorie|kcal/i.test(line)) && !nutritionData.calories) {
                    const calorieMatch = line.match(/([0-9,]+(?:\.[0-9]+)?)[\s]*(?:kcal|cal|칼로리)/i);
                    if (calorieMatch) {
                        nutritionData.calories = parseFloat(calorieMatch[1].replace(/,/g, ''));
                    }
                }
                
                // 탄수화물 추출
                if ((/탄수화물|carbohydrate|carbs/i.test(line)) && !nutritionData.carbs) {
                    const carbMatch = line.match(/([0-9,]+(?:\.[0-9]+)?)[\s]*(?:g|그램)/i);
                    if (carbMatch) {
                        nutritionData.carbs = parseFloat(carbMatch[1].replace(/,/g, ''));
                    }
                }
                
                // 단백질 추출
                if ((/단백질|protein/i.test(line)) && !nutritionData.protein) {
                    const proteinMatch = line.match(/([0-9,]+(?:\.[0-9]+)?)[\s]*(?:g|그램)/i);
                    if (proteinMatch) {
                        nutritionData.protein = parseFloat(proteinMatch[1].replace(/,/g, ''));
                    }
                }
                
                // 지방 추출
                if ((/지방|fat/i.test(line)) && !nutritionData.fat) {
                    const fatMatch = line.match(/([0-9,]+(?:\.[0-9]+)?)[\s]*(?:g|그램)/i);
                    if (fatMatch) {
                        nutritionData.fat = parseFloat(fatMatch[1].replace(/,/g, ''));
                    }
                }
            }

            // 최소 하나의 영양성분이 인식되었는지 확인
            if (nutritionData.calories || nutritionData.carbs || nutritionData.protein || nutritionData.fat) {
                return nutritionData;
            }
            
            return null;
        }

        function displayNutritionResults(nutritionData) {
            const resultDiv = document.getElementById('analysisResult');
            const contentDiv = document.getElementById('analysisContent');
            
            resultDiv.className = 'analysis-result success';
            
            let html = '<div class="nutrition-info">';
            html += '<h5>🎉 영양성분 인식 성공!</h5>';
            
            if (nutritionData.name) {
                html += `<p><strong>제품명:</strong> ${nutritionData.name}</p>`;
            }
            
            html += '<div class="nutrition-values">';
            
            if (nutritionData.calories) {
                html += `<div class="nutrition-value"><strong>칼로리</strong><br>${nutritionData.calories} kcal</div>`;
            }
            if (nutritionData.carbs) {
                html += `<div class="nutrition-value"><strong>탄수화물</strong><br>${nutritionData.carbs} g</div>`;
            }
            if (nutritionData.protein) {
                html += `<div class="nutrition-value"><strong>단백질</strong><br>${nutritionData.protein} g</div>`;
            }
            if (nutritionData.fat) {
                html += `<div class="nutrition-value"><strong>지방</strong><br>${nutritionData.fat} g</div>`;
            }
            
            html += '</div>';
            html += '<button class="apply-nutrition-btn" onclick="applyNutritionData(' + JSON.stringify(nutritionData).replace(/"/g, '&quot;') + ')">✅ 식단 폼에 적용</button>';
            html += '</div>';
            
            contentDiv.innerHTML = html;
        }

        function showAnalysisError(message) {
            const resultDiv = document.getElementById('analysisResult');
            const contentDiv = document.getElementById('analysisContent');
            
            resultDiv.className = 'analysis-result error';
            contentDiv.innerHTML = `<p>⚠️ ${message}</p><p><small>팁: 영양성분표가 명확하고 한글이나 영어로 작성된 이미지를 사용해주세요.</small></p>`;
        }

        function applyNutritionData(nutritionData) {
            if (nutritionData.name) {
                document.getElementById('foodName').value = nutritionData.name;
            }
            if (nutritionData.calories) {
                document.getElementById('foodCalories').value = nutritionData.calories;
            }
            if (nutritionData.carbs) {
                document.getElementById('foodCarbs').value = nutritionData.carbs;
            }
            if (nutritionData.protein) {
                document.getElementById('foodProtein').value = nutritionData.protein;
            }
            if (nutritionData.fat) {
                document.getElementById('foodFat').value = nutritionData.fat;
            }
            
            // 성공 메시지
            alert('영양성분 정보가 식단 폼에 적용되었습니다! 양을 입력해주세요.');
            
            // 양 입력 필드에 포커스
            document.getElementById('foodAmount').focus();
        }

        // 기록 수정 기능
        let editingExerciseIndex = -1;
        let editingFoodIndex = -1;

        // 운동 기록 수정
        function editExercise(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            const exercise = exercises[index];
            
            if (!exercise) {
                alert('수정할 운동 기록을 찾을 수 없습니다.');
                return;
            }
            
            editingExerciseIndex = index;
            
            // 모달에 기존 데이터 채우기
            document.getElementById('editExerciseName').value = exercise.name;
            document.getElementById('editExerciseDuration').value = exercise.duration;
            document.getElementById('editExerciseCalories').value = exercise.calories;
            
            // 모달 열기
            document.getElementById('editExerciseModal').style.display = 'block';
        }

        function closeEditExerciseModal() {
            document.getElementById('editExerciseModal').style.display = 'none';
            editingExerciseIndex = -1;
        }

        // 운동 기록 수정 시 칼로리 재계산
        document.getElementById('editExerciseDuration').addEventListener('input', function() {
            const exerciseName = document.getElementById('editExerciseName').value;
            const duration = parseInt(this.value) || 0;
            
            if (exerciseName && duration > 0) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('editExerciseCalories').value = calories;
            }
        });

        document.getElementById('editExerciseName').addEventListener('input', function() {
            const exerciseName = this.value;
            const duration = parseInt(document.getElementById('editExerciseDuration').value) || 0;
            
            if (exerciseName && duration > 0) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('editExerciseCalories').value = calories;
            }
        });

        // 운동 기록 수정 저장
        document.getElementById('editExerciseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (editingExerciseIndex === -1) {
                alert('수정 중인 기록을 찾을 수 없습니다.');
                return;
            }
            
            const selectedDate = document.getElementById('recordDate').value;
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            
            // 수정된 데이터
            const updatedExercise = {
                name: document.getElementById('editExerciseName').value,
                duration: parseInt(document.getElementById('editExerciseDuration').value),
                calories: parseInt(document.getElementById('editExerciseCalories').value),
                timestamp: exercises[editingExerciseIndex].timestamp // 기존 시간 유지
            };
            
            // 기록 업데이트
            exercises[editingExerciseIndex] = updatedExercise;
            localStorage.setItem(`exercises_${selectedDate}`, JSON.stringify(exercises));
            
            // 화면 새로고침
            displayExercises(exercises);
            updateSummary(exercises, JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || []);
            
            // 비교 탭이 활성화되어 있다면 업데이트
            if (document.getElementById('compareTab').classList.contains('active')) {
                updateComparison();
            }
            
            closeEditExerciseModal();
            alert('운동 기록이 수정되었습니다.');
        });

        // 식단 기록 수정
        function editFood(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const foods = JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || [];
            const food = foods[index];
            
            if (!food) {
                alert('수정할 식단 기록을 찾을 수 없습니다.');
                return;
            }
            
            editingFoodIndex = index;
            
            // 모달에 기존 데이터 채우기
            document.getElementById('editFoodName').value = food.name;
            document.getElementById('editFoodAmount').value = food.amount;
            document.getElementById('editFoodCalories').value = food.calories;
            document.getElementById('editFoodCarbs').value = food.carbs || 0;
            document.getElementById('editFoodProtein').value = food.protein || 0;
            document.getElementById('editFoodFat').value = food.fat || 0;
            document.getElementById('editMealTime').value = food.mealTime;
            
            // 모달 열기
            document.getElementById('editFoodModal').style.display = 'block';
        }

        function closeEditFoodModal() {
            document.getElementById('editFoodModal').style.display = 'none';
            editingFoodIndex = -1;
        }

        // 식단 기록 수정 저장
        document.getElementById('editFoodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (editingFoodIndex === -1) {
                alert('수정 중인 기록을 찾을 수 없습니다.');
                return;
            }
            
            const selectedDate = document.getElementById('recordDate').value;
            const foods = JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || [];
            
            // 수정된 데이터
            const updatedFood = {
                name: document.getElementById('editFoodName').value,
                amount: parseInt(document.getElementById('editFoodAmount').value),
                calories: parseInt(document.getElementById('editFoodCalories').value),
                carbs: parseFloat(document.getElementById('editFoodCarbs').value) || 0,
                protein: parseFloat(document.getElementById('editFoodProtein').value) || 0,
                fat: parseFloat(document.getElementById('editFoodFat').value) || 0,
                mealTime: document.getElementById('editMealTime').value,
                timestamp: foods[editingFoodIndex].timestamp // 기존 시간 유지
            };
            
            // 기록 업데이트
            foods[editingFoodIndex] = updatedFood;
            localStorage.setItem(`foods_${selectedDate}`, JSON.stringify(foods));
            
            // 화면 새로고침
            displayFoods(foods);
            updateSummary(JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [], foods);
            
            closeEditFoodModal();
            alert('식단 기록이 수정되었습니다.');
        });

        // 운동 계획 수정 기능
        let editingPlanIndex = -1;

        function editPlan(index) {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            const plan = plans[index];
            
            if (!plan) {
                alert('수정할 운동 계획을 찾을 수 없습니다.');
                return;
            }
            
            editingPlanIndex = index;
            
            // 모달에 기존 데이터 채우기
            document.getElementById('editPlanExerciseName').value = plan.name;
            document.getElementById('editPlanExerciseDuration').value = plan.duration;
            document.getElementById('editPlanExerciseCalories').value = plan.calories;
            
            // 모달 열기
            document.getElementById('editPlanModal').style.display = 'block';
        }

        function closeEditPlanModal() {
            document.getElementById('editPlanModal').style.display = 'none';
            editingPlanIndex = -1;
        }

        // 운동 계획 수정 시 칼로리 재계산
        document.getElementById('editPlanExerciseDuration').addEventListener('input', function() {
            const exerciseName = document.getElementById('editPlanExerciseName').value;
            const duration = parseInt(this.value) || 0;
            
            if (exerciseName && duration > 0) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('editPlanExerciseCalories').value = calories;
            }
        });

        document.getElementById('editPlanExerciseName').addEventListener('input', function() {
            const exerciseName = this.value;
            const duration = parseInt(document.getElementById('editPlanExerciseDuration').value) || 0;
            
            if (exerciseName && duration > 0) {
                const calories = calculatePersonalizedCalories(exerciseName, duration);
                document.getElementById('editPlanExerciseCalories').value = calories;
            }
        });

        // 운동 계획 수정 저장
        document.getElementById('editPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (editingPlanIndex === -1) {
                alert('수정 중인 계획을 찾을 수 없습니다.');
                return;
            }
            
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            
            // 수정된 데이터
            const updatedPlan = {
                name: document.getElementById('editPlanExerciseName').value,
                duration: parseInt(document.getElementById('editPlanExerciseDuration').value),
                calories: parseInt(document.getElementById('editPlanExerciseCalories').value),
                timestamp: plans[editingPlanIndex].timestamp // 기존 시간 유지
            };
            
            // 계획 업데이트
            plans[editingPlanIndex] = updatedPlan;
            localStorage.setItem(`plans_${selectedDate}`, JSON.stringify(plans));
            
            // 화면 새로고침
            displayPlans(plans);
            updatePlanSummary(plans);
            
            // 비교 탭이 활성화되어 있다면 업데이트
            if (document.getElementById('compareTab').classList.contains('active')) {
                updateComparison();
            }
            
            // 추천 운동 재검토
            checkAndShowRecommendations();
            
            closeEditPlanModal();
            alert('운동 계획이 수정되었습니다.');
        });

        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', function(event) {
            const exerciseModal = document.getElementById('editExerciseModal');
            const foodModal = document.getElementById('editFoodModal');
            const planModal = document.getElementById('editPlanModal');
            const profileModal = document.getElementById('profileModal');
            
            if (event.target === exerciseModal) {
                closeEditExerciseModal();
            } else if (event.target === foodModal) {
                closeEditFoodModal();
            } else if (event.target === planModal) {
                closeEditPlanModal();
            } else if (event.target === profileModal) {
                closeProfileModal();
            }
        });

        // 웹 검색 기능
        function searchFoodNutrition() {
            const query = document.getElementById('webSearchInput').value.trim();
            if (!query) {
                alert('검색할 음식 이름을 입력해주세요.');
                return;
            }

            const searchBtn = document.getElementById('webSearchBtn');
            const resultsDiv = document.getElementById('webSearchResults');
            const searchSection = document.querySelector('.web-search-section');

            // 로딩 상태
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<div class="loading-spinner"></div>검색 중...';
            searchSection.classList.add('searching');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'web-search-results show';
            resultsDiv.innerHTML = '<p>음식 영양 정보를 검색하고 있습니다...</p>';

            // 이전 검색 기록 확인
            const searchHistory = JSON.parse(localStorage.getItem('foodSearchHistory')) || {};
            if (searchHistory[query]) {
                displaySearchResult(searchHistory[query], query);
                resetSearchButton();
                return;
            }

            // 시뮬레이션된 검색 결과 (실제 구현에서는 실제 API를 사용)
            setTimeout(() => {
                const nutritionData = simulateWebSearch(query);
                
                if (nutritionData) {
                    // 검색 기록 저장
                    searchHistory[query] = nutritionData;
                    localStorage.setItem('foodSearchHistory', JSON.stringify(searchHistory));
                    
                    displaySearchResult(nutritionData, query);
                } else {
                    showSearchError(query);
                }
                
                resetSearchButton();
            }, 1500);
        }

        function simulateWebSearch(query) {
            // 실제 구현에서는 구글 검색 API나 영양 데이터베이스 API를 사용
            const mockData = {
                '삼각김밥': { calories: 180, carbs: 35, protein: 4, fat: 2 },
                '삼각김밥 칼로리': { calories: 180, carbs: 35, protein: 4, fat: 2 },
                '치즈버거': { calories: 540, carbs: 40, protein: 25, fat: 31 },
                '치즈버거 칼로리': { calories: 540, carbs: 40, protein: 25, fat: 31 },
                '아메리카노': { calories: 15, carbs: 3, protein: 1, fat: 0.5 },
                '아메리카노 칼로리': { calories: 15, carbs: 3, protein: 1, fat: 0.5 },
                '에스프레소': { calories: 5, carbs: 1, protein: 0.5, fat: 0.2 },
                '에스프레소 칼로리': { calories: 5, carbs: 1, protein: 0.5, fat: 0.2 },
                '아보카도': { calories: 160, carbs: 9, protein: 2, fat: 15 },
                '아보카도 칼로리': { calories: 160, carbs: 9, protein: 2, fat: 15 },
                '연어초밥': { calories: 200, carbs: 30, protein: 25, fat: 1 },
                '연어초밥 칼로리': { calories: 200, carbs: 30, protein: 25, fat: 1 },
                '샐러드': { calories: 20, carbs: 4, protein: 1, fat: 0.2 },
                '그린샐러드': { calories: 20, carbs: 4, protein: 1, fat: 0.2 },
                '시저샐러드': { calories: 150, carbs: 10, protein: 3, fat: 12 },
                '토마토': { calories: 18, carbs: 4, protein: 1, fat: 0.2 },
                '토마토 칼로리': { calories: 18, carbs: 4, protein: 1, fat: 0.2 },
                '파스타': { calories: 220, carbs: 43, protein: 8, fat: 2 },
                '파스타 칼로리': { calories: 220, carbs: 43, protein: 8, fat: 2 }
            };

            // 부분 매칭 검색
            const lowerQuery = query.toLowerCase();
            for (const [key, value] of Object.entries(mockData)) {
                if (key.toLowerCase().includes(lowerQuery) || lowerQuery.includes(key.toLowerCase())) {
                    return { ...value, name: key };
                }
            }

            // 일반적인 검색어에 따른 추정치
            if (lowerQuery.includes('버거') || lowerQuery.includes('햄버거')) {
                return { calories: 500, carbs: 40, protein: 20, fat: 25, name: query };
            }
            if (lowerQuery.includes('피자')) {
                return { calories: 285, carbs: 36, protein: 12, fat: 10, name: query };
            }
            if (lowerQuery.includes('밥') || lowerQuery.includes('라이스')) {
                return { calories: 130, carbs: 28, protein: 2.7, fat: 0.3, name: query };
            }
            if (lowerQuery.includes('샐러드')) {
                return { calories: 25, carbs: 5, protein: 2, fat: 0.3, name: query };
            }
            if (lowerQuery.includes('커피')) {
                return { calories: 5, carbs: 1, protein: 0.3, fat: 0, name: query };
            }
            if (lowerQuery.includes('주스')) {
                return { calories: 45, carbs: 11, protein: 0.5, fat: 0.2, name: query };
            }

            return null;
        }

        function displaySearchResult(nutritionData, query) {
            const resultsDiv = document.getElementById('webSearchResults');
            resultsDiv.className = 'web-search-results show success';
            
            let html = '<div class="nutrition-found">';
            html += '<h5>🎉 영양 정보를 찾았습니다!</h5>';
            html += `<p><strong>음식:</strong> ${nutritionData.name || query}</p>`;
            
            html += '<div class="nutrition-grid">';
            html += `<div class="nutrition-item"><strong>칼로리</strong>${nutritionData.calories || 0} kcal</div>`;
            html += `<div class="nutrition-item"><strong>탄수화물</strong>${nutritionData.carbs || 0} g</div>`;
            html += `<div class="nutrition-item"><strong>단백질</strong>${nutritionData.protein || 0} g</div>`;
            html += `<div class="nutrition-item"><strong>지방</strong>${nutritionData.fat || 0} g</div>`;
            html += '</div>';
            
            html += '<button class="apply-web-search-btn" onclick="applyWebSearchData(' + JSON.stringify(nutritionData).replace(/"/g, '&quot;') + ', \'' + query + '\')">✅ 식단 폼에 적용</button>';
            
            html += '<div class="search-sources">검색 결과는 일반적인 영양 정보를 기반으로 합니다.</div>';
            html += '<div class="search-disclaimer">⚠️ 영양 정보는 제품에 따라 다를 수 있습니다. 정확한 정보는 제품 라벨을 확인해주세요.</div>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }

        function showSearchError(query) {
            const resultsDiv = document.getElementById('webSearchResults');
            resultsDiv.className = 'web-search-results show error';
            resultsDiv.innerHTML = `
                <p>⚠️ "${query}"에 대한 영양 정보를 찾을 수 없습니다.</p>
                <p><small>팁: 더 구체적인 음식 이름을 입력해보세요. (예: "삼각김밥 칼로리")</small></p>
                <p><small>영양성분표 스캔 기능을 사용하거나 직접 입력해주세요.</small></p>
            `;
        }

        function resetSearchButton() {
            const searchBtn = document.getElementById('webSearchBtn');
            const searchSection = document.querySelector('.web-search-section');
            
            searchBtn.disabled = false;
            searchBtn.innerHTML = '🔍 검색';
            searchSection.classList.remove('searching');
        }

        function applyWebSearchData(nutritionData, query) {
            document.getElementById('foodName').value = nutritionData.name || query;
            document.getElementById('foodCalories').value = nutritionData.calories || 0;
            document.getElementById('foodCarbs').value = nutritionData.carbs || 0;
            document.getElementById('foodProtein').value = nutritionData.protein || 0;
            document.getElementById('foodFat').value = nutritionData.fat || 0;
            
            // 기본 양 100g으로 설정
            document.getElementById('foodAmount').value = 100;
            
            alert('영양 정보가 식단 폼에 적용되었습니다! 양을 조정해주세요.');
            
            // 양 입력 필드에 포커스
            document.getElementById('foodAmount').focus();
        }

        // 웹 검색 입력에서 엔터 키 지원
        document.getElementById('webSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFoodNutrition();
            }
        });

        // 토스트 메시지 시스템
        function showToast(message, type = 'warning', duration = 3000) {
            // 기존 토스트 제거
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 새 토스트 생성
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${message}
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(toast);
            
            // 애니메이션으로 표시
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 자동 사라짐
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }

        // 숫자 입력 검증 기능
        function validateNumberInput(input, fieldName) {
            const value = input.value.trim();
            
            // 빈 값은 허용
            if (value === '') {
                return true;
            }
            
            // 숫자 검증
            const numberPattern = /^\d*\.?\d*$/;
            if (!numberPattern.test(value) || isNaN(parseFloat(value))) {
                // 에러 애니메이션
                input.parentElement.classList.add('error');
                setTimeout(() => {
                    input.parentElement.classList.remove('error');
                }, 300);
                
                // 토스트 메시지
                showToast(`${fieldName}에는 숫자만 입력해주세요.`, 'warning');
                
                // 잘못된 값 삭제
                input.value = '';
                input.focus();
                
                return false;
            }
            
            return true;
        }

        // 영양소 필드 이벤트 리스너 추가
        function addNutritionValidation() {
            const nutritionFields = [
                { id: 'foodCalories', name: '칼로리' },
                { id: 'foodCarbs', name: '탄수화물' },
                { id: 'foodProtein', name: '단백질' },
                { id: 'foodFat', name: '지방' },
                { id: 'editFoodCalories', name: '칼로리' },
                { id: 'editFoodCarbs', name: '탄수화물' },
                { id: 'editFoodProtein', name: '단백질' },
                { id: 'editFoodFat', name: '지방' }
            ];

            nutritionFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    // 입력 시 검증
                    element.addEventListener('input', function() {
                        validateNumberInput(this, field.name);
                    });
                    
                    // 붙여넣기 시 검증
                    element.addEventListener('paste', function(e) {
                        setTimeout(() => {
                            validateNumberInput(this, field.name);
                        }, 10);
                    });
                }
            });
        }

        // 기존 음식 칼로리 계산 함수 수정 (수동 입력 지원)
        const originalCalculateFoodCalories = calculateFoodCalories;
        calculateFoodCalories = function() {
            const foodName = document.getElementById('foodName').value;
            const amount = parseInt(document.getElementById('foodAmount').value) || 0;
            
            // 수동 입력된 값이 있는지 확인
            const manualCalories = document.getElementById('foodCalories').value;
            const manualCarbs = document.getElementById('foodCarbs').value;
            const manualProtein = document.getElementById('foodProtein').value;
            const manualFat = document.getElementById('foodFat').value;
            
            // 수동 입력이 있으면 자동 계산 스킵
            if (manualCalories || manualCarbs || manualProtein || manualFat) {
                return;
            }
            
            // 데이터베이스에 있는 음식이면 자동 계산
            if (foodName in foodDatabase && amount > 0) {
                const food = foodDatabase[foodName];
                const ratio = amount / 100;
                
                const calories = Math.round(food.calories * ratio);
                const carbs = Math.round(food.carbs * ratio * 10) / 10;
                const protein = Math.round(food.protein * ratio * 10) / 10;
                const fat = Math.round(food.fat * ratio * 10) / 10;
                
                document.getElementById('foodCalories').value = calories;
                document.getElementById('foodCarbs').value = carbs;
                document.getElementById('foodProtein').value = protein;
                document.getElementById('foodFat').value = fat;
            }
        };

        // 격려 메시지 시스템
        const encouragementMessages = [
            "오늘도 힘차게 운동했네요. 잘하셨습니다!",
            "계획대로 운동을 완주하셨네요! 정말 대단해요.",
            "멋진 성취입니다! 계속 이렇게 꽃꽃히 해나가세요.",
            "오늘의 목표를 달성하셨습니다! 자신을 자랑스러워하세요.",
            "한 단계 더 가까워진 건강한 몸! 오늘도 고생하셨어요.",
            "계획을 지키는 모습이 정말 멋있어요! 이렇게 계속해요.",
            "오늘의 성취가 내일의 동기가 될 거예요. 정말 잘하셨습니다!",
            "필수 운동을 모두 완료하셨네요! 다음에도 화이팅이에요.",
            "건강한 삶을 위한 노력이 빛나네요. 오늘도 수고하셨어요!",
            "계획 달성의 기쁨을 느껴보세요! 당신은 해낼 수 있어요."
        ];

        const celebrationEmojis = ["🎉", "🎆", "🎊", "💪", "✨", "🚀", "🏆", "🌟"];

        function checkPlanCompletion(newExercise) {
            const selectedDate = document.getElementById('recordDate').value;
            const plans = JSON.parse(localStorage.getItem(`plans_${selectedDate}`)) || [];
            
            // 새로 추가된 운동과 일치하는 계획 찾기
            const matchingPlan = plans.find(plan => 
                plan.name === newExercise.name && 
                plan.duration <= newExercise.duration
            );
            
            if (matchingPlan) {
                showEncouragementModal(matchingPlan, newExercise);
                return true;
            }
            
            return false;
        }

        function showEncouragementModal(plan, exercise) {
            const modal = document.getElementById('encouragementModal');
            const emojiElement = document.getElementById('celebrationEmoji');
            const messageElement = document.getElementById('encouragementMessage');
            const detailsElement = document.getElementById('achievementDetails');
            
            // 랜덤 감정 표현 및 메시지
            const randomEmoji = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
            const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
            
            emojiElement.textContent = randomEmoji;
            messageElement.textContent = randomMessage;
            
            // 성취 세부 정보
            const timeDiff = exercise.duration - plan.duration;
            const calorieDiff = exercise.calories - plan.calories;
            
            detailsElement.innerHTML = `
                <div class="achievement-detail">
                    <span>운동:</span>
                    <strong>${exercise.name}</strong>
                </div>
                <div class="achievement-detail">
                    <span>계획 시간:</span>
                    <strong>${plan.duration}분</strong>
                </div>
                <div class="achievement-detail">
                    <span>실제 시간:</span>
                    <strong>${exercise.duration}분 ${timeDiff > 0 ? '(+' + timeDiff + '분!)' : ''}</strong>
                </div>
                <div class="achievement-detail">
                    <span>예상 칼로리:</span>
                    <strong>${plan.calories}kcal</strong>
                </div>
                <div class="achievement-detail">
                    <span>실제 칼로리:</span>
                    <strong>${exercise.calories}kcal ${calorieDiff > 0 ? '(+' + calorieDiff + 'kcal!)' : ''}</strong>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeEncouragementModal() {
            const modal = document.getElementById('encouragementModal');
            modal.classList.remove('show');
        }

        // 기존 운동 기록 추가 함수 수정
        const originalExerciseFormSubmit = document.getElementById('exerciseForm').onsubmit;
        
        document.getElementById('exerciseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedDate = document.getElementById('recordDate').value;
            const exercise = {
                name: document.getElementById('exerciseName').value,
                duration: parseInt(document.getElementById('exerciseDuration').value),
                calories: parseInt(document.getElementById('exerciseCalories').value),
                timestamp: new Date().toLocaleTimeString()
            };
            
            const exercises = JSON.parse(localStorage.getItem(`exercises_${selectedDate}`)) || [];
            exercises.push(exercise);
            localStorage.setItem(`exercises_${selectedDate}`, JSON.stringify(exercises));
            
            displayExercises(exercises);
            updateSummary(exercises, JSON.parse(localStorage.getItem(`foods_${selectedDate}`)) || []);
            
            // 계획 달성 검사 및 격려 메시지
            checkPlanCompletion(exercise);
            
            // 추천 운동 재검토
            checkAndShowRecommendations();
            
            // 폼 초기화
            this.reset();
            document.getElementById('exerciseCalories').value = '';
        });

        // 모달 외부 클릭 시 닫기 (격려 모달 제외)
        window.addEventListener('click', function(event) {
            const exerciseModal = document.getElementById('editExerciseModal');
            const foodModal = document.getElementById('editFoodModal');
            const planModal = document.getElementById('editPlanModal');
            const profileModal = document.getElementById('profileModal');
            const encouragementModal = document.getElementById('encouragementModal');
            
            if (event.target === exerciseModal) {
                closeEditExerciseModal();
            } else if (event.target === foodModal) {
                closeEditFoodModal();
            } else if (event.target === planModal) {
                closeEditPlanModal();
            } else if (event.target === profileModal) {
                closeProfileModal();
            }
            // 격려 모달은 확인 버튼으로만 닫기
        });

        // 초기 데이터 로드 및 검증 기능 추가
        loadUserProfile();
        loadData();
        addNutritionValidation();
    </script>
</body>
</html>